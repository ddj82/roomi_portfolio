<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì´ë‹ˆì‹œìŠ¤ í•´ì™¸ì¹´ë“œ ì „ìš© ê²°ì œ</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .title {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 20px;
        }
        .card-guide {
            background: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .card-guide h4 {
            color: #1976d2;
            margin: 0 0 10px 0;
        }
        .card-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .card-brand {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
        }
        #debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-size: 12px;
            color: #495057;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        #error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="title">ğŸŒ ì´ë‹ˆì‹œìŠ¤ í•´ì™¸ì¹´ë“œ ì „ìš© ê²°ì œ</h2>

    <div class="card-guide">
        <h4>ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í•´ì™¸ì¹´ë“œ</h4>
        <p>ì´ ê²°ì œëŠ” í•´ì™¸ ë°œê¸‰ ì¹´ë“œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="card-list">
            <span class="card-brand">VISA</span>
            <span class="card-brand">MasterCard</span>
            <span class="card-brand">AMEX</span>
            <span class="card-brand">JCB</span>
            <span class="card-brand">DINERS</span>
        </div>
        <small>â€» êµ­ë‚´ ì€í–‰ì—ì„œ ë°œê¸‰í•œ ì¹´ë“œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>
    </div>

    <div class="loading">
        <div class="spinner"></div>
        <p>ê²°ì œì°½ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="debug-info"></div>
    <div id="error-message"></div>
</div>

<script>
    function addDebugInfo(message) {
        const debugDiv = document.getElementById('debug-info');
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}\n`;
        debugDiv.textContent += logMessage;
        debugDiv.scrollTop = debugDiv.scrollHeight;
        console.log(`[${timestamp}] ${message}`);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const params = {
        orderId: urlParams.get('orderId') || `order_${Date.now()}`,
        amount: parseInt(urlParams.get('amount')) || 1000,
        buyerName: urlParams.get('buyerName') || "í™ê¸¸ë™",
        buyerEmail: urlParams.get('buyerEmail') || "test@example.com",
        buyerTel: urlParams.get('buyerTel') || "01012345678",
        buyerAddr: urlParams.get('buyerAddr') || "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬",
        redirectUrl: urlParams.get('redirectUrl') || "com.myno1214.roomi://result",
        // ì´ë‹ˆì‹œìŠ¤ ì „ìš© ì±„ë„í‚¤ë¡œ ë³€ê²½ (ì‹¤ì œ ì´ë‹ˆì‹œìŠ¤ ì±„ë„í‚¤ ì‚¬ìš©)

        channelKey: urlParams.get('channelKey') || "channel-key-0dfb8c53-05f6-4017-8ce5-6cff2f815022",
        storeId: urlParams.get('storeId') || "store-7bb98274-0fb5-4b2e-8d60-d3bff2f3ca85"
    };

    window.onload = function () {
        addDebugInfo('ğŸš€ ì´ë‹ˆì‹œìŠ¤ í•´ì™¸ì¹´ë“œ ì „ìš© ê²°ì œ ì‹œì‘');
        addDebugInfo(`ì£¼ë¬¸ ID: ${params.orderId}`);
        addDebugInfo(`ê²°ì œ ê¸ˆì•¡: ${params.amount.toLocaleString()}ì›`);

        // ì´ë‹ˆì‹œìŠ¤ í•´ì™¸ì¹´ë“œ ì „ìš© ê²°ì œ ìš”ì²­
        const paymentRequest = {
            storeId: params.storeId,
            paymentId: params.orderId,
            channelKey: params.channelKey,
            payMethod: 'CARD',

            // ğŸŒ í•´ì™¸ì¹´ë“œ ì „ìš© ì„¤ì •
            locale : 'EN_US', // ì˜ì–´ë¡œ ì„¤ì •í•˜ì—¬ í•´ì™¸ ê²°ì œ í™˜ê²½ ì¡°ì„±

            // ì´ë‹ˆì‹œìŠ¤ í•´ì™¸ì¹´ë“œ ì „ìš© ì˜µì…˜
            cardOptions: {
                enableCardInstallment: false, // í• ë¶€ ë¹„í™œì„±í™” (êµ­ë‚´ì¹´ë“œ ì£¼ìš” ê¸°ëŠ¥)
                enableCardPoint: false,       // ì¹´ë“œ í¬ì¸íŠ¸ ë¹„í™œì„±í™”
                enableCardDiscount: false,    // ì¹´ë“œ ì¦‰ì‹œí• ì¸ ë¹„í™œì„±í™”

                // í•´ì™¸ì¹´ë“œ ë¸Œëœë“œë§Œ í—ˆìš©
                allowedCardCompanies: [
                    "VI,MA,AX,JC,DI"
                    // ë‹¤ì´ë„ˆìŠ¤
                ]
            },

            orderName: "í•´ì™¸ì¹´ë“œ ì „ìš© ê²°ì œ ìƒí’ˆ",
            totalAmount: params.amount,
            currency: "KRW",

            customer: {
                customerId: params.buyerTel,
                fullName: params.buyerName,
                phoneNumber: params.buyerTel,
                email: params.buyerEmail
            },

            redirectUrl: params.redirectUrl,

            // ì´ë‹ˆì‹œìŠ¤ ì „ìš© bypass íŒŒë¼ë¯¸í„°
            bypass: {
                inicis: {
                    // ì´ë‹ˆì‹œìŠ¤ í•´ì™¸ì¹´ë“œ ì „ìš© ì„¤ì •
                    acceptmethod: "CARD(VI,MA,AX,JC,DI):no_installment:no_interest", // í•´ì™¸ì¹´ë“œë§Œ, í• ë¶€ ë¶ˆê°€
                    card_code: "VI,MA,AX,JC,DI", // VISA, MasterCard, AMEX, JCB, DINERSë§Œ
                    quotaopt: "0",               // ì¼ì‹œë¶ˆë§Œ í—ˆìš©
                    nointerest: "no",            // ë¬´ì´ì í• ë¶€ ë¹„í—ˆìš©
                    international_card_yn: "Y",  // í•´ì™¸ì¹´ë“œë§Œ í—ˆìš©
                    domestic_card_yn: "N",       // êµ­ë‚´ì¹´ë“œ ë¹„í—ˆìš©
                    foreign_card_yn: "Y"         // ì™¸êµ­ì¹´ë“œ í—ˆìš©
                }
            },

            // ì¶”ê°€ ë©”íƒ€ë°ì´í„°
            customData: {
                cardType: "overseas_only",
                pgProvider: "inicis",
                allowDomestic: false,
                enforceOverseas: true
            }
        };

        addDebugInfo('ğŸ“¤ ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ìš”ì²­ ë°ì´í„°:');
        addDebugInfo(JSON.stringify(paymentRequest, null, 2));

        // ê²°ì œ ìš”ì²­ ì‹¤í–‰
        PortOne.requestPayment(paymentRequest)
            .then(result => {
                addDebugInfo("âœ… ê²°ì œ ì‘ë‹µ ìˆ˜ì‹ :");
                addDebugInfo(JSON.stringify(result, null, 2));

                if (result.code != null) {
                    // ê²°ì œ ì‹¤íŒ¨
                    throw new Error(`ê²°ì œ ì‹¤íŒ¨: ${result.message} (ì½”ë“œ: ${result.code})`);
                } else {
                    // ê²°ì œ ì„±ê³µ
                    addDebugInfo("ğŸ‰ ê²°ì œ ì„±ê³µ!");
                    addDebugInfo(`ê±°ë˜ ID: ${result.txId}`);
                    addDebugInfo(`ê²°ì œ ID: ${result.paymentId}`);

                    // í•´ì™¸ì¹´ë“œ ê²€ì¦ì„ ìœ„í•œ ì„œë²„ í˜¸ì¶œ (ì„ íƒì‚¬í•­)
                    verifyOverseasCard(result)
                        .then(verification => {
                            if (verification.isOverseasCard) {
                                addDebugInfo("âœ… í•´ì™¸ì¹´ë“œ ê²€ì¦ ì™„ë£Œ");
                                // ì„±ê³µ ì²˜ë¦¬
                                setTimeout(() => {
                                    window.location.href = `${params.redirectUrl}?success=true&paymentId=${result.paymentId}&txId=${result.txId}`;
                                }, 2000);
                            } else {
                                addDebugInfo("âŒ êµ­ë‚´ì¹´ë“œ ì‚¬ìš© ê°ì§€ - ê²°ì œ ì·¨ì†Œ ì§„í–‰");
                                // êµ­ë‚´ì¹´ë“œë¡œ ê²°ì œëœ ê²½ìš° ì·¨ì†Œ
                                cancelPayment(result.paymentId, "í•´ì™¸ì¹´ë“œ ì „ìš© ê²°ì œì—ì„œ êµ­ë‚´ì¹´ë“œ ì‚¬ìš©");
                            }
                        })
                        .catch(error => {
                            addDebugInfo("âš ï¸ ì¹´ë“œ ê²€ì¦ ì‹¤íŒ¨, ìˆ˜ë™ í™•ì¸ í•„ìš”");
                            addDebugInfo(`ê²€ì¦ ì˜¤ë¥˜: ${error.message}`);
                            // ê²€ì¦ ì‹¤íŒ¨ì‹œì—ë„ ê²°ì œ ì™„ë£Œë¡œ ì²˜ë¦¬ (ìˆ˜ë™ í™•ì¸)
                            setTimeout(() => {
                                window.location.href = `${params.redirectUrl}?success=true&paymentId=${result.paymentId}&needsVerification=true`;
                            }, 2000);
                        });
                }
            })
            .catch(error => {
                addDebugInfo("âŒ ê²°ì œ ì‹¤íŒ¨:");
                addDebugInfo(JSON.stringify(error, null, 2));

                const errorMessage = error.message || error.code || 'Unknown error';
                document.getElementById('error-message').innerHTML = `
                    <strong>ê²°ì œ ì‹¤íŒ¨</strong><br>
                    ${errorMessage}<br>
                    <small>í•´ì™¸ ë°œê¸‰ ì¹´ë“œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                `;
                document.getElementById('error-message').style.display = 'block';

                // ìƒì„¸ ì—ëŸ¬ ì •ë³´
                if (error.details) {
                    addDebugInfo("ğŸ“‹ ì—ëŸ¬ ìƒì„¸:");
                    addDebugInfo(JSON.stringify(error.details, null, 2));
                }

                // ì—ëŸ¬ íƒ€ì…ë³„ ì•ˆë‚´
                if (errorMessage.includes('card') || errorMessage.includes('ì¹´ë“œ')) {
                    addDebugInfo("ğŸ’¡ í•´ì™¸ ë°œê¸‰ ì¹´ë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                }
            });
    };

    // í•´ì™¸ì¹´ë“œ ê²€ì¦ í•¨ìˆ˜ (ì„œë²„ API í˜¸ì¶œ)
    async function verifyOverseasCard(paymentResult) {
        try {
            addDebugInfo("ğŸ” í•´ì™¸ì¹´ë“œ ê²€ì¦ ì‹œì‘...");

            const response = await fetch('/api/verify-overseas-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    paymentId: paymentResult.paymentId,
                    txId: paymentResult.txId,
                    storeId: params.storeId
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            addDebugInfo(`ê²€ì¦ ê²°ê³¼: ${result.isOverseasCard ? 'í•´ì™¸ì¹´ë“œ' : 'êµ­ë‚´ì¹´ë“œ'}`);

            return result;

        } catch (error) {
            addDebugInfo(`ê²€ì¦ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
            // ê²€ì¦ ì‹¤íŒ¨ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ í—ˆìš© (ìˆ˜ë™ í™•ì¸)
            return { isOverseasCard: true, needsManualVerification: true };
        }
    }

    // ê²°ì œ ì·¨ì†Œ í•¨ìˆ˜
    async function cancelPayment(paymentId, reason) {
        try {
            addDebugInfo("ğŸ”„ ê²°ì œ ì·¨ì†Œ ì§„í–‰...");

            const response = await fetch('/api/cancel-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    paymentId: paymentId,
                    reason: reason,
                    storeId: params.storeId
                })
            });

            const result = await response.json();

            if (result.success) {
                addDebugInfo("âœ… ê²°ì œ ì·¨ì†Œ ì™„ë£Œ");
                alert("êµ­ë‚´ì¹´ë“œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ì™¸ ë°œê¸‰ ì¹´ë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                window.location.href = `${params.redirectUrl}?cancelled=true&reason=domestic_card`;
            } else {
                addDebugInfo("âŒ ê²°ì œ ì·¨ì†Œ ì‹¤íŒ¨");
                alert("ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
            }

        } catch (error) {
            addDebugInfo(`ê²°ì œ ì·¨ì†Œ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
            alert("ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
        }
    }
</script>
</body>
</html>